@model IEnumerable<MstStudent>

@{
    ViewData["Title"] = "Student Grades";
}

<h2>Student Grades</h2>

<button type="button" class="btn btn-primary mb-3"
        data-bs-toggle="modal"
        data-bs-target="#exampleModalCenter">
    Create Student
</button>



<form method="get" class="mb-3 d-flex">
        <input type="text" name="search" placeholder="Search by name" value="@ViewBag.Search" class="form-control me-2" />
        <select name="filter" class="form-select me-2">
            <option value="">All</option>
            <option value="PASS" selected="@(ViewBag.Filter=="PASS")">PASS</option>
            <option value="FAIL" selected="@(ViewBag.Filter=="FAIL")">FAIL</option>
        </select>
        <button class="btn btn-primary">Search</button>
    </form>

<div id="studentTableContainer">
    @await Html.PartialAsync("_StudentTablePartial", Model)
</div>





<!-- Add Student Modal -->
<div class="modal fade" id="exampleModalCenter" tabindex="-1" aria-labelledby="exampleModalLongTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">

            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="exampleModalLongTitle">Add Student</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <form id="createStudentForm">

                    <div class="form-group mb-3">
                        <label for="StudentName">Student Name</label>
                        <input type="text" name="StudentName" id="StudentName" class="form-control" required />
                    </div>

                    <div class="form-group mb-3">
                        <label for="SubjectKey">Subject</label>
                        <select name="SubjectKey" id="SubjectKey" class="form-select" required>
                            <option value="">-- Select Subject --</option>
                            @foreach (var subject in ViewBag.Subjects)
                            {
                                <option value="@subject.SubjectKey">@subject.SubjectName</option>
                            }
                        </select>
                    </div>

                    <div class="form-group mb-3">
                        <label for="StudentGrade">Student Grade</label>
                        <input type="number" name="Grade" id="StudentGrade" class="form-control" required />
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" id="btnSaveStudent" class="btn btn-success">Save Student</button>
            </div>

        </div>
    </div>
</div>




<!-- Edit Subject Modal Placeholders -->
<div id="modal-placeholder"></div>

<!-- Delete Subject Modal -->
<div class="modal fade" id="modalDeleteStudent" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Delete Subject</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this subject?</p>
                <input type="hidden" id="deleteStudentKey" />
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button class="btn btn-danger" id="btnDeleteStudent">Delete</button>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <script>
    // --- Delete Student ---//


        $(document).on('click', '.delete-btn', function () {
            var id = $(this).data('id');
            $('#deleteStudentKey').val(id);
            var modal = new bootstrap.Modal(document.getElementById('modalDeleteStudent'));
            modal.show();
        });

        $('#btnDeleteStudent').click(function () {
            var id = $('#deleteStudentKey').val();
            $.ajax({
                url: '/Student/Delete',
                type: 'POST', // Use POST if your controller accepts POST
                data: { StudentKey: id },
                success: function (res) {
                    if (res.success) {
                        $('#modalDeleteStudent').modal('hide');
                        $('tr[data-id="' + id + '"]').remove();
                        showToast(res.message || "Student deleted successfully");
                    } else {
                        alert(res.message || "Error deleting student");
                    }
                },
                error: function () {
                    alert("Error deleting student");
                }
            });
        });



        // --- Edit Subject ---//

        $(document).on('click', '.edit-btn', function () {
            var id = $(this).data('id');
            $.get('/Student/Edit', { id: id }, function (html) {
                $('#modal-placeholder').html(html);
                $('#editFormModal').modal('show');
            });
        });

        $(document).on('submit', '#editForm', function (e) {
            e.preventDefault();
            $.ajax({
                url: '/Student/Edit',
                type: 'POST',
                data: $(this).serialize(),
                success: function (res) {
                    if (res.success) {
                        $('#editFormModal').modal('hide');

                        var id = $('#editForm input[name="StudentKey"]').val();
                        $('tr[data-id="' + id + '"] .student-name').text($('#editForm input[name="StudentName"]').val());
                        $('tr[data-id="' + id + '"] .student-subject').text($('#editForm select[name="SubjectKey"] option:selected').text());
                        $('tr[data-id="' + id + '"] .student-grade').text($('#editForm input[name="Grade"]').val());
                        $('tr[data-id="' + id + '"] .student-remarks')
                            .text($('#editForm input[name="Remarks"]').val())
                            .removeClass('text-success text-danger')
                            .addClass($('#editForm input[name="Remarks"]').val() == 'PASS' ? 'text-success' : 'text-danger');

                        showToast(res.message || "Student updated successfully");
                    } else {
                        alert(res.message || "Error updating student");
                    }
                },
                error: function () {
                    alert("Error updating student");
                }
            });
        });</script>



    <script>

        document.getElementById("btnSaveStudent").addEventListener("click", function () {
            const form = document.getElementById("createStudentForm");
            const formData = new FormData(form);

            fetch("/Student/Create", {
                method: "POST",
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Close modal
                        const modalEl = document.getElementById("exampleModalCenter");
                        const modalInstance = bootstrap.Modal.getInstance(modalEl);
                        modalInstance.hide();

                        // Show toast
                        showToast(data.message || "Student created successfully", "success");

                        // Optional: refresh or update table
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        showToast(data.message || "Error creating student", "error");
                    }
                })
                .catch(error => {
                    showToast("Error saving student: " + error, "error");
                });
        });




        
        </script>

}